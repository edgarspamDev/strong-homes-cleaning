import React, { useState } from 'react';
import { Phone, Mail, MapPin, Clock, AlertCircle } from 'lucide-react';
import { SeoHead } from '../SeoHead';
import {
  validateContactForm,
  checkRateLimit,
  recordSubmitAttempt,
  type ContactFormData,
} from '../utils/security';

export default function Contact() {
  const [formData, setFormData] = useState<ContactFormData>({
    name: '',
    email: '',
    phone: '',
    message: '',
    _gotcha: '',
  });

  const [errors, setErrors] = useState<Record<string, string>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [rateLimitError, setRateLimitError] = useState<string | null>(null);
  const [submitSuccess, setSubmitSuccess] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;

    // Clear error for this field when user starts typing
    if (errors[name]) {
      setErrors((prev: Record<string, string>) => {
        const newErrors = { ...prev };
        delete newErrors[name];
        return newErrors;
      });
    }

    setFormData({
      ...formData,
      [name]: value,
    });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    // Reset errors and success state
    setErrors({});
    setRateLimitError(null);
    setSubmitSuccess(false);

    // Double-submit protection
    if (isSubmitting) return;

    // Rate limiting check
    const rateLimitCheck = checkRateLimit();
    if (!rateLimitCheck.allowed) {
      setRateLimitError(
        `Too many submission attempts. Please wait ${rateLimitCheck.waitMinutes} minute(s) before trying again.`
      );
      return;
    }

    // Validate and sanitize form data
    const validationResult = validateContactForm(formData);

    if (!validationResult.isValid) {
      if ('errors' in validationResult) {
        setErrors(validationResult.errors);
      }
      return;
    }

    // Record attempt for rate limiting
    recordSubmitAttempt();

    // Set submitting state
    setIsSubmitting(true);

    try {
      // In a real implementation, you would send validationResult.sanitized to your backend
      await new Promise(resolve => setTimeout(resolve, 500));

      setSubmitSuccess(true);
      setFormData({ name: '', email: '', phone: '', message: '', _gotcha: '' });
    } catch (error) {
      // Handle submission error without leaking implementation details
      setErrors({ submit: 'Something went wrong. Please try again or call us at (219) 615-9477.' });
    } finally {
      setIsSubmitting(false);
    }
  };

  const infoItems = [
    {
      icon: Phone,
      title: 'Phone',
      value: '(219) 615-9477',
      href: 'tel:2196159477',
    },
    {
      icon: Mail,
      title: 'Email',
      value: 'info@stronghomescleaning.com',
      href: 'mailto:info@stronghomescleaning.com',
    },
    {
      icon: Clock,
      title: 'Hours',
      value: 'Mon–Sat: 8am–6pm',
    },
    {
      icon: MapPin,
      title: 'Service Area',
      value: 'Lake & Porter Counties, Indiana',
    },
  ];

  return (
    <>
      <SeoHead />

      <section className="relative overflow-hidden bg-[#0B1120] text-white">
        <div className="absolute inset-0 bg-gradient-to-b from-[#0B1120] via-[#0B1120]/85 to-[#0B1120]" />
        <div className="absolute inset-0 opacity-30" style={{ background: 'radial-gradient(60% 60% at 20% 10%, rgba(197,160,101,0.18), transparent)' }} />
        <div className="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-14 text-center">
          <p className="text-sm uppercase tracking-[0.2em] text-slate-300 mb-3">Contact</p>
          <h1 className="text-4xl font-bold mb-3">We&apos;re here to help</h1>
          <p className="text-lg text-slate-100">Reach out for booking questions, special requests, or service coverage.</p>
        </div>
      </section>

      <div className="bg-[#F8FAFC] py-14 px-4">
        <div className="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-10">
          <div className="space-y-6">
            <h2 className="text-2xl font-bold text-[#0B1120]">Get in touch</h2>
            <p className="text-slate-600">Licensed and insured crews serving Lake & Porter Counties. Expect a quick response.</p>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {infoItems.map((item) => {
                const Icon = item.icon;
                const content = (
                  <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:-translate-y-0.5 hover:shadow-md transition duration-150">
                    <div className="flex items-center gap-3 mb-2">
                      <div className="h-10 w-10 rounded-lg bg-[#C5A065]/15 text-[#C5A065] flex items-center justify-center">
                        <Icon size={18} />
                      </div>
                      <div className="text-sm font-semibold text-[#0B1120]">{item.title}</div>
                    </div>
                    <div className="text-slate-700 text-sm leading-relaxed">{item.value}</div>
                  </div>
                );
                return item.href ? (
                  <a key={item.title} href={item.href} className="block focus:outline-none focus:ring-2 focus:ring-[#C5A065] focus:ring-offset-2 focus:ring-offset-[#F8FAFC] rounded-xl">
                    {content}
                  </a>
                ) : (
                  <div key={item.title}>{content}</div>
                );
              })}
            </div>
          </div>

          <div className="bg-white border border-slate-200 rounded-2xl shadow-lg p-8">
            import React, { useState } from 'react';
            import { Phone, Mail, MapPin, Clock } from 'lucide-react';
            import { SeoHead } from '../SeoHead';

            export default function Contact() {
              const [formData, setFormData] = useState({
                name: '',
                email: '',
                phone: '',
                message: '',
                _gotcha: '',
              });

              const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
                setFormData({
                  ...formData,
                  [e.target.name]: e.target.value,
                });
              };

              const handleSubmit = (e: React.FormEvent) => {
                e.preventDefault();
                if (formData._gotcha) return;
                setFormData({ name: '', email: '', phone: '', message: '', _gotcha: '' });
              };

              const infoItems = [
                {
                  icon: Phone,
                  title: 'Phone',
                  value: '(219) 615-9477',
                  href: 'tel:2196159477',
                },
                {
                  icon: Mail,
                  title: 'Email',
                  value: 'info@stronghomescleaning.com',
                  href: 'mailto:info@stronghomescleaning.com',
                },
                {
                  icon: Clock,
                  title: 'Hours',
                  value: 'Mon–Sat: 8am–6pm',
                },
                {
                  icon: MapPin,
                  title: 'Service Area',
                  value: 'Lake & Porter Counties, Indiana',
                },
              ];

              return (
                <>
                  <SeoHead />

                  <section className="relative overflow-hidden bg-[#0B1120] text-white">
                    <div className="absolute inset-0 bg-gradient-to-b from-[#0B1120] via-[#0B1120]/85 to-[#0B1120]" />
                    <div
                      className="absolute inset-0 opacity-30"
                      style={{ background: 'radial-gradient(60% 60% at 20% 10%, rgba(197,160,101,0.18), transparent)' }}
                    />
                    <div className="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-14 text-center">
                      <p className="text-sm uppercase tracking-[0.2em] text-slate-300 mb-3">Contact</p>
                      <h1 className="text-4xl font-bold mb-3">We're here to help</h1>
                      <p className="text-lg text-slate-100">Reach out for booking questions, special requests, or service coverage.</p>
                    </div>
                  </section>

                  <div className="bg-[#F8FAFC] py-14 px-4">
                    <div className="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-10">
                      <div className="space-y-6">
                        <h2 className="text-2xl font-bold text-[#0B1120]">Get in touch</h2>
                        <p className="text-slate-600">Licensed and insured crews serving Lake & Porter Counties. Expect a quick response.</p>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          {infoItems.map((item) => {
                            const Icon = item.icon;
                            const content = (
                              <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:-translate-y-0.5 hover:shadow-md transition duration-150">
                                <div className="flex items-center gap-3 mb-2">
                                  <div className="h-10 w-10 rounded-lg bg-[#C5A065]/15 text-[#C5A065] flex items-center justify-center">
                                    <Icon size={18} />
                                  </div>
                                  <div className="text-sm font-semibold text-[#0B1120]">{item.title}</div>
                                </div>
                                <div className="text-slate-700 text-sm leading-relaxed">{item.value}</div>
                              </div>
                            );
                            return item.href ? (
                              <a
                                key={item.title}
                                href={item.href}
                                className="block focus:outline-none focus:ring-2 focus:ring-[#C5A065] focus:ring-offset-2 focus:ring-offset-[#F8FAFC] rounded-xl"
                              >
                                {content}
                              </a>
                            ) : (
                              <div key={item.title}>{content}</div>
                            );
                          })}
                        </div>
                      </div>

                      <div className="bg-white border border-slate-200 rounded-2xl shadow-lg p-8">
                        <h2 className="text-2xl font-bold text-[#0B1120] mb-4">Send a message</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                          <div>
                            <label className="block text-[#0B1120] font-semibold mb-2">Name</label>
                            <input
                              type="text"
                              name="name"
                              value={formData.name}
                              onChange={handleChange}
                              required
                              className="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C5A065]"
                              placeholder="Your name"
                            />
                          </div>

                          <div>
                            <label className="block text-[#0B1120] font-semibold mb-2">Email</label>
                            <input
                              type="email"
                              name="email"
                              value={formData.email}
                              onChange={handleChange}
                              required
                              className="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C5A065]"
                              placeholder="your@email.com"
                            />
                          </div>

                          <div>
                            <label className="block text-[#0B1120] font-semibold mb-2">Phone</label>
                            <input
                              type="tel"
                              name="phone"
                              value={formData.phone}
                              onChange={handleChange}
                              className="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C5A065]"
                              placeholder="(219) 123-4567"
                            />
                          </div>

                          <div>
                            <label className="block text-[#0B1120] font-semibold mb-2">Message</label>
                            <textarea
                              name="message"
                              value={formData.message}
                              onChange={handleChange}
                              required
                              rows={4}
                              className="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C5A065]"
                              placeholder="How can we help?"
                            ></textarea>
                          </div>

                          <input
                            type="text"
                            name="_gotcha"
                            value={formData._gotcha}
                            onChange={handleChange}
                            style={{ display: 'none' }}
                          />

                          <button
                            type="submit"
                            className="w-full bg-[#0B1120] text-white font-semibold py-3 rounded-lg hover:bg-[#0B1120]/90 transition"
                          >
                            Send Message
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </>
              );
            }
